<!DOCTYPE html>
<html lang="ko" class="h-100">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="" />
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors" />
  <meta name="generator" content="Hugo 0.104.2" />
  <title>STADY</title>
  <!-- css 파일 -->
  
  <!-- bootstrap css cdn -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" >
    <!-- font awesome 5.14.5-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <!-- JS 파일 -->
  <script src="/static/js/bootstrap.bundle.min.js?after"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-modal/2.2.6/js/bootstrap-modalmanager.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

  <style>
    .stady_btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .stady_wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .cam_size {
      width: 375px;
      height: 375px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;

      background-color: #e9ecef;
      margin-bottom: 10px;
    }

    .nav_logo {
      width: 100px;
      height: 40px;
    }

    #my-header {}

    #main_nav {
      padding-top: 1rem;
      padding-bottom: 1rem;
      background-color: #fff;
      max-width: 1100px;
      margin: 0 auto;
    }
  </style>
</head>

<body id="body" class="h-100 text-center" style="background-color: #00b395;">
  <div class="w-100 h-100 p-3 mx-auto">
    <header class="mb-auto" style="background-color: white; max-width: 720px; margin: 0 auto;">
      <div class="contain">
        <div class="fixed-top" id="main_nav">
          <h3 class="float-md-start mb-0">
            <a href="/">
              <img class="nav_logo" src="/static/images/stady_1.png" />
            </a>
          </h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link fw-bold py-1 px-0" aria-current="true" href="/">Home</a>
            <a class="nav-link fw-bold py-1 px-0" aria-current="true" href="">Community</a>
            <a class="nav-link fw-bold py-1 px-0" aria-current="true" href="{% url 'studies:studies' %}">스터디 모임</a>
            <div style="margin-left: 20px; margin-right: 10px">
              <div class="post_header_more_btn_box">
                <div class="btn-group">
                  <img type="button" class="img_circle dropdown-toggle" width="30px" height="30px"
                    src="/static/images/stady_bear_face.png" data-bs-toggle="dropdown" aria-expanded="false" />
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="{% url 'profile:profile' %}">프로필</a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'user:update' %}">회원정보수정</a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'user:logout' %}">로그아웃</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </div>

    </header>

    <main class="container" style="height: 500px; margin-top : 100px;">
            <h3>좋아할만한 스터디를 골라봤어요!</h3>
            <div class="row text-start" id="main-wrap">
            </div>
        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
        
        <!-- Modal -->
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="1" aria-labelledby="staticBackdropLabel" aria-hidden="true" style="">
        <div class="modal-dialog modal-xl" style="border-radius: 10px; overflow: hidden;">
            <div class="modal-content">
            <div class="modal-body" style="padding: 0;">
                <div id="modal-head" class="p-3" style="height: 300px; ">
        
                    <div class="" style="align-self: end;">
                        <b><h3 id="study-title" class="text-start" style="color: white;"></h3></b>
                        <button id="status" style="height: 35px;" type="button" class="btn btn-primary">Understood</button>
                        <i class="fas fa-user-alt" style="font-size: 25px; color : white;"></i>
                        <span id="study-ratio" class="p-1" style="color: white; border: 1px solid white; border-radius: 20%;"></span>
                        <span style="cursor: pointer;" id="study-like"></span>
                        <!-- <span style="color: white;">태그들 있을 예정</span> -->
                    </div>
                    <i class="fas fa-times text-end" data-bs-dismiss="modal" aria-label="Close" style="margin-left: auto; cursor: pointer; color: rgb(255, 255, 255); font-size: 30px;"></i>
                </div>
            </div>
            <div class="modal-footer" style="display: block; text-align: left;">
                <h6 id="author" class="text-secondary"></h6>
        
                <div id="content"></div>
                <h4 class="text-center">이런 스터디는 어때?</h4>
                <div id="recommend-wrap" class="row">


                </div>
            </div>
            </div>
        </div>
        </div>
        
        
        <input type="text" name="search_input" id="search_input" onchange="search()" >

    </main>
  </div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  
  <script>


      // async function searchFilter() {
      //   let search_input = document.getElementById("search_input").value;
      //   console.log('검색성공')
      //   const response = await fetch(`http://127.0.0.1:8000/studies/search/?search=${search_input}`, {
      //       method: 'GET',
      //   })
      //   console.log(response)
      //   const response_json = await response.json();
      //   console.log(response_json)
      //   const searchedQuestions = response_json;
        
      //   function load(response_json) {
      //             console.log('성공:', response_json);
      //             let allTemp = ``
      //             for(var i = 0; i < response_json.length; i++){
      //                 var study = response_json[i]
      //                 console.log(study)
      //                 var temp = `
      //                     <div class="mb-3 col-md-4 col-sm-6 p-2" style="cursor: pointer;">
      //                         <div id="study" style="background-color: white; border-radius : 5px" onclick="viewStudy(${study.id})">
      //                             <img src="${hostUrl}${study.thumbnail_img}" type="button" class="card-img-top" alt="...">
      //                             <div class="card-body">
      //                                 <h5 class="card-title">${study.title}</h5>
      //                                 <p class="text-start text-second">
      //                                     ${study.user} </br>
      //                                     <i class="fas fa-user-alt"></i> ${study.now_cnt}/${study.headcount}</br>
      //                                     <span><i class="fas fa-tags"></i> ${study.tags}</span></br>
      //                                 </p>
      //                             </div>
      //                         </div>
      //                     </div>
      //                 `
      //                 allTemp += temp
      //           }
      //           $('#main-wrap').html(allTemp)

      //       }
      //       load()
      // }
      // searchFilter()



    const hostUrl = 'http://127.0.0.1:8000'

    window.onload = function loadStudy(){
        const mainWrap = document.getElementById('main-wrap');

        $.ajax({
            type: 'GET',

            data: {},
            headers : {
              "Authorization" : "Bearer " + localStorage.getItem("access"),
            },

            url: `http://127.0.0.1:8000/studies/`,

            success: function (result) {
                console.log('성공:', result);
                let allTemp = ``
                for(var i = 0; i < result['results'].length; i++){
                    var study = result['results'][i]
                    console.log(study)
                    var temp = `
                        <div class="mb-3 col-md-4 col-sm-6 p-2" style="cursor: pointer;">
                            <div id="study" style="background-color: white; border-radius : 5px" onclick="viewStudy(${study.id})">
                                <img src="${hostUrl}${study.thumbnail_img}" type="button" class="card-img-top" alt="...">
                                <div class="card-body">
                                    <h5 class="card-title">${study.title}</h5>
                                    <p class="text-start text-second">
                                        ${study.user} </br>
                                        <i class="fas fa-user-alt"></i> ${study.now_cnt}/${study.headcount}</br>
                                        <span><i class="fas fa-tags"></i> ${study.tags}</span></br>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `
                    allTemp += temp
                }
                $('#main-wrap').html(allTemp)
            },
            
        });
    }


    
      function search(){
        const mainWrap = document.getElementById('main-wrap');
        let search_input = document.getElementById("search_input").value;
        console.log('검색성공')

        $.ajax({
            type: 'GET',

            data: {},
            headers : {
              "Authorization" : "Bearer " + localStorage.getItem("access"),
            },

            url: `http://127.0.0.1:8000/studies/search/?search=${search_input}`,

            success: function (result) {
                console.log('성공:', result);
                let allTemp = ``
                for(var i = 0; i < result.length; i++){
                    var study = result[i]
                    console.log(study)
                    var temp = `
                        <div class="mb-3 col-md-4 col-sm-6 p-2" style="cursor: pointer;">
                            <div id="study" style="background-color: white; border-radius : 5px" onclick="viewStudy(${study.id})">
                                <img src="${hostUrl}${study.thumbnail_img}" type="button" class="card-img-top" alt="...">
                                <div class="card-body">
                                    <h5 class="card-title">${study.title}</h5>
                                    <p class="text-start text-second">
                                        ${study.user} </br>
                                        <i class="fas fa-user-alt"></i> ${study.now_cnt}/${study.headcount}</br>
                                        <span><i class="fas fa-tags"></i> ${study.tags}</span></br>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `
                    allTemp += temp
                }
                $('#main-wrap').html(allTemp)
            },
            
        });
    }






    function viewStudy(study_id){

        const modal = document.getElementById('staticBackdrop');
        let tumbnailImg = document.getElementById('tumbnail-img');
        console.log(study_id)

        $.ajax({
            type: 'GET',

            data: {},
            headers : {
              "Authorization" : "Bearer " + localStorage.getItem("access"),
            },

            url: `${hostUrl}/api/studies/${study_id}/`,

            success: function (result) {
                let studyDetail = result["study_detail"]
                let recommendStudy = result["recommend_study"]
                console.log('성공:', result, result['thumbnail_img']);
                // $('#thumbnail-img').attr('src', result['thumbnail_img']);
                $('#modal-head').attr('style', `background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.2)), url(${hostUrl}${studyDetail['thumbnail_img']});
                                            background-position: center;
                                            background-size: cover;
                                            height : 300px;
                                            display: flex;
                `)
                $('#study-title').text(studyDetail['title'])
                $('#author').text(studyDetail['user'])
                $('#content').text(studyDetail['content'])
                
                let isStudent = studyDetail['is_student']
                let isAuthor = studyDetail['is_author']
                let sended = studyDetail['sended']
                let onOffLine = studyDetail['on_off_line']
                let isLike = studyDetail['is_like']
                let headCount = studyDetail['headcount']
                let nowCnt = studyDetail['now_cnt']

                $('#study-ratio').text(`${nowCnt}/${headCount}`)

                if (isAuthor){
                    $('#status').text('관리 페이지')
                }else if(isStudent){
                    $('#status').text('스터디 이동')
                }else if(sended){
                    $('#status').text('요청 취소')
                }else{
                    $('#status').text('신청하기')
                    $('#status').attr('onclick', `propose(${studyDetail.id}, "propose")`)
                }

                if(isLike){
                    $('#study-like').html('<i style="color : yellow; font-size : 25px" class="fas fa-star"></i>')
                    $('#study-like').attr('onclick', `sutdyLike(${study_id})`)
                }else{
                    $('#study-like').html('<i style="color : yellow; font-size : 25px" class="far fa-star"></i>')
                    $('#study-like').attr('onclick', `sutdyLike(${study_id})`)
                }


                loadRecommendStudy(recommendStudy)
            },
            
        });
        $('#staticBackdrop').modal('show')
    }
    function propose(study_id, type){
        console.log('dd')
        $.ajax({
            type: 'GET',

            data: {type : type},
            headers : {
              "Authorization" : "Bearer " + localStorage.getItem("access"),
            },

            url: `${hostUrl}/api/studies/${study_id}`,

            success: function (result) {
                if (type === "propose"){
                    $('#status').text('신청 취소')
                    $('#status').attr('onclick', `propose(${study_id}, "cancle")`)
                }else if(type === "cancle"){
                    $('#status').text('신청하기')
                    $('#status').attr('onclick', `propose(${study_id}, "propose")`)
                }
                
            },
        });
    }
    function loadRecommendStudy(recommendStudy){
        let allTemp = ``
        for(var i = 0; i < recommendStudy.length; i++){
            var study = recommendStudy[i]
            console.log(study)
            var temp = `
                <div class="mb-3 col-lg-4 col-md-6 p-2" style="cursor: pointer;">
                    <div id="study" style="background-color: rgb(181,214,146); border-radius : 5px" onclick="viewStudy(${study.id})">
                        <img src="${hostUrl}${study.thumbnail_img}" type="button" class="card-img-top" alt="...">
                        <h5 class="card-title">${study.title}</h5>
                        <div class="card-body text-start">
                            <span><i class="fas fa-tags"></i>${study.tags}</span>
                            <span><i class="fas fa-user-alt"></i>${study.now_cnt}/${study.headcount}</span>
                        </div>
                    </div>
                </div>
            `
            allTemp += temp
        }
        $('#recommend-wrap').html(allTemp)
    }

    function sutdyLike(study_id){
        $.ajax({
            type: 'GET',

            data: {},
            headers : {
              "Authorization" : "Bearer " + localStorage.getItem("access"),
            },

            url: `${hostUrl}/api/studies/${study_id}/like`,

            success: function (result) {
                $('#study-like').html('<i style="color : yellow; font-size : 25px" class="fas fa-star"></i>')
                
            },
        });
    }
    
  </script>
</body>

</html>